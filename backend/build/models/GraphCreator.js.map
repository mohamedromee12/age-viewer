{"version":3,"file":"GraphCreator.js","names":["Papa","require","_require","getDelete","toAgeProps","QueryBuilder","GraphCreator","_ref","arguments","length","undefined","nodes","edges","graphName","dropGraph","_classCallCheck2","nodefiles","edgefiles","query","graph","drop","create","labels","_createClass2","key","value","_createNodeLabel","_asyncToGenerator2","_regenerator","mark","_callee","label","makeLabel","wrap","_callee$","_context","prev","next","concat","push","stop","createNodeLabel","_x","apply","_createEdgeLabel","_callee2","_callee2$","_context2","createEdgeLabel","_x2","_createNode","_callee3","node","type","qbuild","CREATENODE","_args3","_callee3$","_context3","returnAs","clause","insertQuery","getGeneratedQuery","createNode","_x3","_x4","_createEdge","_callee4","edge","startv","startid","endv","endid","eprops","CREATEEDGE","_args4","_callee4$","_context4","createEdge","_x5","_x6","_createGraph","_callee5","dropgraph","creategraph","_args5","_callee5$","_context5","createGraph","_readData","_callee6","file","resolve","_callee6$","_context6","parse","complete","res","errors","forEach","e","data","splice","row","o","header","readData","_x7","_x8","_x9","_parseData","_callee7","_this","_callee7$","_context7","Promise","all","map","originalname","buffer","toString","sent","nodeFile","n","edgeFile","abrupt","parseData","module","exports"],"sources":["../../src/models/GraphCreator.js"],"sourcesContent":["const Papa = require('papaparse');\nconst { getDelete, toAgeProps } = require('../util/ObjectExtras');\nconst QueryBuilder = require('./QueryBuilder');\n\nclass GraphCreator {\n    constructor({nodes, edges, graphName, dropGraph}={}){\n        this.nodefiles = nodes;\n        this.edgefiles = edges;\n        this.dropGraph = dropGraph;\n        this.graphName = graphName;\n        this.nodes = [];\n        this.edges = [];\n        this.query = {\n            graph: {\n                drop: null,\n                create: null,\n            },\n            labels:[],\n            nodes: [],\n            edges: []\n        };\n    }\n    async createNodeLabel(label){\n        const makeLabel = `SELECT create_vlabel('${this.graphName}', '${label}');`\n        this.query.labels.push(makeLabel);\n    }\n\n    async createEdgeLabel(label){\n        const makeLabel = `SELECT create_elabel('${this.graphName}', '${label}');`;\n        this.query.labels.push(makeLabel); \n    }\n\n    async createNode(node, type, qbuild = new QueryBuilder({\n        graphName:this.graphName,\n        returnAs:'v'\n    })){\n        const CREATENODE = \n        `(:${type} ${toAgeProps(node)})`;\n\n        if (qbuild.clause === ''){\n            qbuild.create();\n        }\n        \n        qbuild.insertQuery(CREATENODE);\n        this.query.nodes.push(qbuild.getGeneratedQuery());\n    }\n    async createEdge(edge, type, qbuild = new QueryBuilder(\n        {\n            graphName: this.graphName,\n            returnAs: 'e'\n        }\n    )){\n        const startv = getDelete(edge, \"start_vertex_type\");\n        const startid = getDelete(edge, \"start_id\");\n        const endv = getDelete(edge, \"end_vertex_type\");\n        const endid = getDelete(edge, \"end_id\");\n        const eprops = edge;\n        const CREATEEDGE = \n        `MATCH\n            (a:${startv} {id:'${startid}'}),\n            (b:${endv} {id:'${endid}'})\n            CREATE (a)-[e:${type} ${toAgeProps(eprops)}]->(b)`;\n        \n        qbuild.insertQuery(CREATEEDGE);\n\n        this.query.edges.push(qbuild.getGeneratedQuery());\n    }\n    async createGraph(drop=false){\n        if (drop){\n            const dropgraph = `SELECT * FROM drop_graph('${this.graphName}', true);`;\n            this.query.graph.drop = dropgraph;\n        }\n        const creategraph = `SELECT * FROM create_graph('${this.graphName}');`;\n        this.query.graph.create = creategraph;\n    }\n    async readData(file, type, resolve){\n        Papa.parse(file, {\n            complete: (res) => {\n                res.errors.forEach((e)=>{\n                    if (e.type === 'FieldMismatch'){\n                        res.data.splice(e.row, 1);\n                    }\n                })\n                const o = {\n                    type,\n                    data:res.data\n                }\n                resolve(o);\n            },\n            header: true,\n        });\n    }\n    async parseData(){\n        this.createGraph(this.dropGraph);\n\n        this.nodes = await Promise.all(this.nodefiles.map((node) => new Promise((resolve) => {\n            this.createNodeLabel(node.originalname);\n            this.readData(node.buffer.toString('utf8'), node.originalname, resolve);\n        })));\n        this.nodes.forEach((nodeFile)=>{\n            nodeFile.data.forEach((n)=>{\n                this.createNode(n, nodeFile.type);\n            });\n        });\n        this.edges = await Promise.all(this.edgefiles.map((edge) => new Promise((resolve) => {\n            this.createEdgeLabel(edge.originalname);\n            this.readData(edge.buffer.toString('utf8'), edge.originalname, resolve);\n        })));\n\n        this.edges.forEach((edgeFile)=>{\n            edgeFile.data.forEach((e)=>{\n                this.createEdge(e, edgeFile.type);\n            });\n        });\n        return this.query;\n        \n    }\n};\n\nmodule.exports = GraphCreator;\n"],"mappings":"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"}